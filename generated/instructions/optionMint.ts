/**
 * This code was AUTOGENERATED using the Codama library.
 * Please DO NOT EDIT THIS FILE, instead use visitors
 * to add features, then rerun Codama to update it.
 *
 * @see https://github.com/codama-idl/codama
 */

import {
  addDecoderSizePrefix,
  addEncoderSizePrefix,
  combineCodec,
  fixDecoderSize,
  fixEncoderSize,
  getAddressDecoder,
  getAddressEncoder,
  getBytesDecoder,
  getBytesEncoder,
  getF64Decoder,
  getF64Encoder,
  getI64Decoder,
  getI64Encoder,
  getProgramDerivedAddress,
  getStructDecoder,
  getStructEncoder,
  getU32Decoder,
  getU32Encoder,
  getU64Decoder,
  getU64Encoder,
  getUtf8Decoder,
  getUtf8Encoder,
  transformEncoder,
  type AccountMeta,
  type AccountSignerMeta,
  type Address,
  type Codec,
  type Decoder,
  type Encoder,
  type Instruction,
  type InstructionWithAccounts,
  type InstructionWithData,
  type ReadonlyAccount,
  type ReadonlyUint8Array,
  type TransactionSigner,
  type WritableAccount,
  type WritableSignerAccount,
} from "@solana/kit";
import { OPTION_PROGRAM_PROGRAM_ADDRESS } from "../programs";
import {
  expectAddress,
  expectSome,
  getAccountMetaFactory,
  type ResolvedAccount,
} from "../shared";
import {
  getOptionTypeDecoder,
  getOptionTypeEncoder,
  type OptionType,
  type OptionTypeArgs,
} from "../types";

export const OPTION_MINT_DISCRIMINATOR = new Uint8Array([
  210, 192, 217, 89, 138, 0, 94, 90,
]);

export function getOptionMintDiscriminatorBytes() {
  return fixEncoderSize(getBytesEncoder(), 8).encode(OPTION_MINT_DISCRIMINATOR);
}

export type OptionMintInstruction<
  TProgram extends string = typeof OPTION_PROGRAM_PROGRAM_ADDRESS,
  TAccountOptionAccount extends string | AccountMeta<string> = string,
  TAccountLongMint extends string | AccountMeta<string> = string,
  TAccountShortMint extends string | AccountMeta<string> = string,
  TAccountMintAuthority extends string | AccountMeta<string> = string,
  TAccountMakerLongAccount extends string | AccountMeta<string> = string,
  TAccountMakerShortAccount extends string | AccountMeta<string> = string,
  TAccountLongMetadataAccount extends string | AccountMeta<string> = string,
  TAccountShortMetadataAccount extends string | AccountMeta<string> = string,
  TAccountMarketData extends string | AccountMeta<string> = string,
  TAccountUnderlyingMint extends string | AccountMeta<string> = string,
  TAccountOptionPool extends string | AccountMeta<string> = string,
  TAccountEscrowLongAccount extends string | AccountMeta<string> = string,
  TAccountPremiumVault extends string | AccountMeta<string> = string,
  TAccountCollateralPool extends string | AccountMeta<string> = string,
  TAccountCollateralVault extends string | AccountMeta<string> = string,
  TAccountMakerCollateralAccount extends string | AccountMeta<string> = string,
  TAccountWriterPosition extends string | AccountMeta<string> = string,
  TAccountVault extends string | AccountMeta<string> = string,
  TAccountVaultTokenAccount extends string | AccountMeta<string> = string,
  TAccountEscrowState extends string | AccountMeta<string> = string,
  TAccountEscrowAuthority extends string | AccountMeta<string> = string,
  TAccountEscrowTokenAccount extends string | AccountMeta<string> = string,
  TAccountPoolLoan extends string | AccountMeta<string> = string,
  TAccountMaker extends string | AccountMeta<string> = string,
  TAccountTokenProgram extends string | AccountMeta<string> =
    "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA",
  TAccountAssociatedTokenProgram extends string | AccountMeta<string> =
    "ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL",
  TAccountTokenMetadataProgram extends string | AccountMeta<string> =
    "metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s",
  TAccountSystemProgram extends string | AccountMeta<string> =
    "11111111111111111111111111111111",
  TAccountRent extends string | AccountMeta<string> =
    "SysvarRent111111111111111111111111111111111",
  TRemainingAccounts extends readonly AccountMeta<string>[] = [],
> = Instruction<TProgram> &
  InstructionWithData<ReadonlyUint8Array> &
  InstructionWithAccounts<
    [
      TAccountOptionAccount extends string
        ? WritableAccount<TAccountOptionAccount>
        : TAccountOptionAccount,
      TAccountLongMint extends string
        ? WritableAccount<TAccountLongMint>
        : TAccountLongMint,
      TAccountShortMint extends string
        ? WritableAccount<TAccountShortMint>
        : TAccountShortMint,
      TAccountMintAuthority extends string
        ? ReadonlyAccount<TAccountMintAuthority>
        : TAccountMintAuthority,
      TAccountMakerLongAccount extends string
        ? WritableAccount<TAccountMakerLongAccount>
        : TAccountMakerLongAccount,
      TAccountMakerShortAccount extends string
        ? WritableAccount<TAccountMakerShortAccount>
        : TAccountMakerShortAccount,
      TAccountLongMetadataAccount extends string
        ? WritableAccount<TAccountLongMetadataAccount>
        : TAccountLongMetadataAccount,
      TAccountShortMetadataAccount extends string
        ? WritableAccount<TAccountShortMetadataAccount>
        : TAccountShortMetadataAccount,
      TAccountMarketData extends string
        ? ReadonlyAccount<TAccountMarketData>
        : TAccountMarketData,
      TAccountUnderlyingMint extends string
        ? ReadonlyAccount<TAccountUnderlyingMint>
        : TAccountUnderlyingMint,
      TAccountOptionPool extends string
        ? WritableAccount<TAccountOptionPool>
        : TAccountOptionPool,
      TAccountEscrowLongAccount extends string
        ? WritableAccount<TAccountEscrowLongAccount>
        : TAccountEscrowLongAccount,
      TAccountPremiumVault extends string
        ? WritableAccount<TAccountPremiumVault>
        : TAccountPremiumVault,
      TAccountCollateralPool extends string
        ? WritableAccount<TAccountCollateralPool>
        : TAccountCollateralPool,
      TAccountCollateralVault extends string
        ? WritableAccount<TAccountCollateralVault>
        : TAccountCollateralVault,
      TAccountMakerCollateralAccount extends string
        ? WritableAccount<TAccountMakerCollateralAccount>
        : TAccountMakerCollateralAccount,
      TAccountWriterPosition extends string
        ? WritableAccount<TAccountWriterPosition>
        : TAccountWriterPosition,
      TAccountVault extends string
        ? WritableAccount<TAccountVault>
        : TAccountVault,
      TAccountVaultTokenAccount extends string
        ? WritableAccount<TAccountVaultTokenAccount>
        : TAccountVaultTokenAccount,
      TAccountEscrowState extends string
        ? WritableAccount<TAccountEscrowState>
        : TAccountEscrowState,
      TAccountEscrowAuthority extends string
        ? ReadonlyAccount<TAccountEscrowAuthority>
        : TAccountEscrowAuthority,
      TAccountEscrowTokenAccount extends string
        ? WritableAccount<TAccountEscrowTokenAccount>
        : TAccountEscrowTokenAccount,
      TAccountPoolLoan extends string
        ? WritableAccount<TAccountPoolLoan>
        : TAccountPoolLoan,
      TAccountMaker extends string
        ? WritableSignerAccount<TAccountMaker> &
            AccountSignerMeta<TAccountMaker>
        : TAccountMaker,
      TAccountTokenProgram extends string
        ? ReadonlyAccount<TAccountTokenProgram>
        : TAccountTokenProgram,
      TAccountAssociatedTokenProgram extends string
        ? ReadonlyAccount<TAccountAssociatedTokenProgram>
        : TAccountAssociatedTokenProgram,
      TAccountTokenMetadataProgram extends string
        ? ReadonlyAccount<TAccountTokenMetadataProgram>
        : TAccountTokenMetadataProgram,
      TAccountSystemProgram extends string
        ? ReadonlyAccount<TAccountSystemProgram>
        : TAccountSystemProgram,
      TAccountRent extends string
        ? ReadonlyAccount<TAccountRent>
        : TAccountRent,
      ...TRemainingAccounts,
    ]
  >;

export type OptionMintInstructionData = {
  discriminator: ReadonlyUint8Array;
  optionType: OptionType;
  strikePrice: number;
  expirationDate: bigint;
  quantity: bigint;
  underlyingAsset: Address;
  underlyingSymbol: string;
  makerCollateralAmount: bigint;
  borrowedAmount: bigint;
};

export type OptionMintInstructionDataArgs = {
  optionType: OptionTypeArgs;
  strikePrice: number;
  expirationDate: number | bigint;
  quantity: number | bigint;
  underlyingAsset: Address;
  underlyingSymbol: string;
  makerCollateralAmount: number | bigint;
  borrowedAmount: number | bigint;
};

export function getOptionMintInstructionDataEncoder(): Encoder<OptionMintInstructionDataArgs> {
  return transformEncoder(
    getStructEncoder([
      ["discriminator", fixEncoderSize(getBytesEncoder(), 8)],
      ["optionType", getOptionTypeEncoder()],
      ["strikePrice", getF64Encoder()],
      ["expirationDate", getI64Encoder()],
      ["quantity", getU64Encoder()],
      ["underlyingAsset", getAddressEncoder()],
      [
        "underlyingSymbol",
        addEncoderSizePrefix(getUtf8Encoder(), getU32Encoder()),
      ],
      ["makerCollateralAmount", getU64Encoder()],
      ["borrowedAmount", getU64Encoder()],
    ]),
    (value) => ({ ...value, discriminator: OPTION_MINT_DISCRIMINATOR }),
  );
}

export function getOptionMintInstructionDataDecoder(): Decoder<OptionMintInstructionData> {
  return getStructDecoder([
    ["discriminator", fixDecoderSize(getBytesDecoder(), 8)],
    ["optionType", getOptionTypeDecoder()],
    ["strikePrice", getF64Decoder()],
    ["expirationDate", getI64Decoder()],
    ["quantity", getU64Decoder()],
    ["underlyingAsset", getAddressDecoder()],
    [
      "underlyingSymbol",
      addDecoderSizePrefix(getUtf8Decoder(), getU32Decoder()),
    ],
    ["makerCollateralAmount", getU64Decoder()],
    ["borrowedAmount", getU64Decoder()],
  ]);
}

export function getOptionMintInstructionDataCodec(): Codec<
  OptionMintInstructionDataArgs,
  OptionMintInstructionData
> {
  return combineCodec(
    getOptionMintInstructionDataEncoder(),
    getOptionMintInstructionDataDecoder(),
  );
}

export type OptionMintAsyncInput<
  TAccountOptionAccount extends string = string,
  TAccountLongMint extends string = string,
  TAccountShortMint extends string = string,
  TAccountMintAuthority extends string = string,
  TAccountMakerLongAccount extends string = string,
  TAccountMakerShortAccount extends string = string,
  TAccountLongMetadataAccount extends string = string,
  TAccountShortMetadataAccount extends string = string,
  TAccountMarketData extends string = string,
  TAccountUnderlyingMint extends string = string,
  TAccountOptionPool extends string = string,
  TAccountEscrowLongAccount extends string = string,
  TAccountPremiumVault extends string = string,
  TAccountCollateralPool extends string = string,
  TAccountCollateralVault extends string = string,
  TAccountMakerCollateralAccount extends string = string,
  TAccountWriterPosition extends string = string,
  TAccountVault extends string = string,
  TAccountVaultTokenAccount extends string = string,
  TAccountEscrowState extends string = string,
  TAccountEscrowAuthority extends string = string,
  TAccountEscrowTokenAccount extends string = string,
  TAccountPoolLoan extends string = string,
  TAccountMaker extends string = string,
  TAccountTokenProgram extends string = string,
  TAccountAssociatedTokenProgram extends string = string,
  TAccountTokenMetadataProgram extends string = string,
  TAccountSystemProgram extends string = string,
  TAccountRent extends string = string,
> = {
  /**
   * Option account - derived from option parameters (NOT maker)
   * Uses init_if_needed so multiple makers can use the same option
   */
  optionAccount?: Address<TAccountOptionAccount>;
  /**
   * LONG token mint - one per unique option parameters (buyers hold these)
   * Uses init_if_needed so multiple makers share the same token
   */
  longMint?: Address<TAccountLongMint>;
  /**
   * SHORT token mint - one per unique option parameters (writers hold these)
   * Uses init_if_needed so multiple makers share the same token
   */
  shortMint?: Address<TAccountShortMint>;
  mintAuthority?: Address<TAccountMintAuthority>;
  /** Maker's LONG token account (receives LONG tokens to deposit in pool) */
  makerLongAccount?: Address<TAccountMakerLongAccount>;
  /** Maker's SHORT token account (receives SHORT tokens as proof of writing) */
  makerShortAccount?: Address<TAccountMakerShortAccount>;
  longMetadataAccount: Address<TAccountLongMetadataAccount>;
  shortMetadataAccount: Address<TAccountShortMetadataAccount>;
  /** Market data account - provides baseline historical volatility for initial IV */
  marketData?: Address<TAccountMarketData>;
  /** Underlying asset mint (e.g., WSOL) - required for collateral and pool initialization */
  underlyingMint: Address<TAccountUnderlyingMint>;
  /** Option pool - aggregated liquidity pool for this option */
  optionPool?: Address<TAccountOptionPool>;
  /** Pool's escrow for holding LONG tokens (for buyers to purchase) */
  escrowLongAccount?: Address<TAccountEscrowLongAccount>;
  /** Pool's vault for collecting premiums (in underlying asset) */
  premiumVault?: Address<TAccountPremiumVault>;
  /** Collateral pool for this option */
  collateralPool?: Address<TAccountCollateralPool>;
  /** Collateral vault (ATA holding collateral) */
  collateralVault?: Address<TAccountCollateralVault>;
  /** Maker's collateral account (source of maker's own collateral) */
  makerCollateralAccount: Address<TAccountMakerCollateralAccount>;
  /** Writer's unified position account (single source of truth) */
  writerPosition?: Address<TAccountWriterPosition>;
  /** OMLP vault (optional - only required if borrowing) */
  vault?: Address<TAccountVault>;
  /** Vault's token account (optional - only required if borrowing) */
  vaultTokenAccount?: Address<TAccountVaultTokenAccount>;
  /** Escrow state PDA (optional - only required if borrowing) */
  escrowState?: Address<TAccountEscrowState>;
  /** Escrow authority PDA (optional - only required if borrowing) */
  escrowAuthority?: Address<TAccountEscrowAuthority>;
  /** Escrow token account (optional - only required if borrowing) */
  escrowTokenAccount?: Address<TAccountEscrowTokenAccount>;
  /** Pool loan account (optional - only required if borrowing) */
  poolLoan?: Address<TAccountPoolLoan>;
  maker: TransactionSigner<TAccountMaker>;
  tokenProgram?: Address<TAccountTokenProgram>;
  associatedTokenProgram?: Address<TAccountAssociatedTokenProgram>;
  tokenMetadataProgram?: Address<TAccountTokenMetadataProgram>;
  systemProgram?: Address<TAccountSystemProgram>;
  rent?: Address<TAccountRent>;
  optionType: OptionMintInstructionDataArgs["optionType"];
  strikePrice: OptionMintInstructionDataArgs["strikePrice"];
  expirationDate: OptionMintInstructionDataArgs["expirationDate"];
  quantity: OptionMintInstructionDataArgs["quantity"];
  underlyingAsset: OptionMintInstructionDataArgs["underlyingAsset"];
  underlyingSymbol: OptionMintInstructionDataArgs["underlyingSymbol"];
  makerCollateralAmount: OptionMintInstructionDataArgs["makerCollateralAmount"];
  borrowedAmount: OptionMintInstructionDataArgs["borrowedAmount"];
};

export async function getOptionMintInstructionAsync<
  TAccountOptionAccount extends string,
  TAccountLongMint extends string,
  TAccountShortMint extends string,
  TAccountMintAuthority extends string,
  TAccountMakerLongAccount extends string,
  TAccountMakerShortAccount extends string,
  TAccountLongMetadataAccount extends string,
  TAccountShortMetadataAccount extends string,
  TAccountMarketData extends string,
  TAccountUnderlyingMint extends string,
  TAccountOptionPool extends string,
  TAccountEscrowLongAccount extends string,
  TAccountPremiumVault extends string,
  TAccountCollateralPool extends string,
  TAccountCollateralVault extends string,
  TAccountMakerCollateralAccount extends string,
  TAccountWriterPosition extends string,
  TAccountVault extends string,
  TAccountVaultTokenAccount extends string,
  TAccountEscrowState extends string,
  TAccountEscrowAuthority extends string,
  TAccountEscrowTokenAccount extends string,
  TAccountPoolLoan extends string,
  TAccountMaker extends string,
  TAccountTokenProgram extends string,
  TAccountAssociatedTokenProgram extends string,
  TAccountTokenMetadataProgram extends string,
  TAccountSystemProgram extends string,
  TAccountRent extends string,
  TProgramAddress extends Address = typeof OPTION_PROGRAM_PROGRAM_ADDRESS,
>(
  input: OptionMintAsyncInput<
    TAccountOptionAccount,
    TAccountLongMint,
    TAccountShortMint,
    TAccountMintAuthority,
    TAccountMakerLongAccount,
    TAccountMakerShortAccount,
    TAccountLongMetadataAccount,
    TAccountShortMetadataAccount,
    TAccountMarketData,
    TAccountUnderlyingMint,
    TAccountOptionPool,
    TAccountEscrowLongAccount,
    TAccountPremiumVault,
    TAccountCollateralPool,
    TAccountCollateralVault,
    TAccountMakerCollateralAccount,
    TAccountWriterPosition,
    TAccountVault,
    TAccountVaultTokenAccount,
    TAccountEscrowState,
    TAccountEscrowAuthority,
    TAccountEscrowTokenAccount,
    TAccountPoolLoan,
    TAccountMaker,
    TAccountTokenProgram,
    TAccountAssociatedTokenProgram,
    TAccountTokenMetadataProgram,
    TAccountSystemProgram,
    TAccountRent
  >,
  config?: { programAddress?: TProgramAddress },
): Promise<
  OptionMintInstruction<
    TProgramAddress,
    TAccountOptionAccount,
    TAccountLongMint,
    TAccountShortMint,
    TAccountMintAuthority,
    TAccountMakerLongAccount,
    TAccountMakerShortAccount,
    TAccountLongMetadataAccount,
    TAccountShortMetadataAccount,
    TAccountMarketData,
    TAccountUnderlyingMint,
    TAccountOptionPool,
    TAccountEscrowLongAccount,
    TAccountPremiumVault,
    TAccountCollateralPool,
    TAccountCollateralVault,
    TAccountMakerCollateralAccount,
    TAccountWriterPosition,
    TAccountVault,
    TAccountVaultTokenAccount,
    TAccountEscrowState,
    TAccountEscrowAuthority,
    TAccountEscrowTokenAccount,
    TAccountPoolLoan,
    TAccountMaker,
    TAccountTokenProgram,
    TAccountAssociatedTokenProgram,
    TAccountTokenMetadataProgram,
    TAccountSystemProgram,
    TAccountRent
  >
> {
  // Program address.
  const programAddress =
    config?.programAddress ?? OPTION_PROGRAM_PROGRAM_ADDRESS;

  // Original accounts.
  const originalAccounts = {
    optionAccount: { value: input.optionAccount ?? null, isWritable: true },
    longMint: { value: input.longMint ?? null, isWritable: true },
    shortMint: { value: input.shortMint ?? null, isWritable: true },
    mintAuthority: { value: input.mintAuthority ?? null, isWritable: false },
    makerLongAccount: {
      value: input.makerLongAccount ?? null,
      isWritable: true,
    },
    makerShortAccount: {
      value: input.makerShortAccount ?? null,
      isWritable: true,
    },
    longMetadataAccount: {
      value: input.longMetadataAccount ?? null,
      isWritable: true,
    },
    shortMetadataAccount: {
      value: input.shortMetadataAccount ?? null,
      isWritable: true,
    },
    marketData: { value: input.marketData ?? null, isWritable: false },
    underlyingMint: { value: input.underlyingMint ?? null, isWritable: false },
    optionPool: { value: input.optionPool ?? null, isWritable: true },
    escrowLongAccount: {
      value: input.escrowLongAccount ?? null,
      isWritable: true,
    },
    premiumVault: { value: input.premiumVault ?? null, isWritable: true },
    collateralPool: { value: input.collateralPool ?? null, isWritable: true },
    collateralVault: { value: input.collateralVault ?? null, isWritable: true },
    makerCollateralAccount: {
      value: input.makerCollateralAccount ?? null,
      isWritable: true,
    },
    writerPosition: { value: input.writerPosition ?? null, isWritable: true },
    vault: { value: input.vault ?? null, isWritable: true },
    vaultTokenAccount: {
      value: input.vaultTokenAccount ?? null,
      isWritable: true,
    },
    escrowState: { value: input.escrowState ?? null, isWritable: true },
    escrowAuthority: {
      value: input.escrowAuthority ?? null,
      isWritable: false,
    },
    escrowTokenAccount: {
      value: input.escrowTokenAccount ?? null,
      isWritable: true,
    },
    poolLoan: { value: input.poolLoan ?? null, isWritable: true },
    maker: { value: input.maker ?? null, isWritable: true },
    tokenProgram: { value: input.tokenProgram ?? null, isWritable: false },
    associatedTokenProgram: {
      value: input.associatedTokenProgram ?? null,
      isWritable: false,
    },
    tokenMetadataProgram: {
      value: input.tokenMetadataProgram ?? null,
      isWritable: false,
    },
    systemProgram: { value: input.systemProgram ?? null, isWritable: false },
    rent: { value: input.rent ?? null, isWritable: false },
  };
  const accounts = originalAccounts as Record<
    keyof typeof originalAccounts,
    ResolvedAccount
  >;

  // Original args.
  const args = { ...input };

  // Resolve default values.
  if (!accounts.optionAccount.value) {
    accounts.optionAccount.value = await getProgramDerivedAddress({
      programAddress,
      seeds: [
        getBytesEncoder().encode(
          new Uint8Array([111, 112, 116, 105, 111, 110]),
        ),
        getAddressEncoder().encode(expectSome(args.underlyingAsset)),
        getOptionTypeEncoder().encode(expectSome(args.optionType)),
        getF64Encoder().encode(expectSome(args.strikePrice)),
        getI64Encoder().encode(expectSome(args.expirationDate)),
      ],
    });
  }
  if (!accounts.longMint.value) {
    accounts.longMint.value = await getProgramDerivedAddress({
      programAddress,
      seeds: [
        getBytesEncoder().encode(
          new Uint8Array([108, 111, 110, 103, 95, 109, 105, 110, 116]),
        ),
        getAddressEncoder().encode(expectAddress(accounts.optionAccount.value)),
      ],
    });
  }
  if (!accounts.shortMint.value) {
    accounts.shortMint.value = await getProgramDerivedAddress({
      programAddress,
      seeds: [
        getBytesEncoder().encode(
          new Uint8Array([115, 104, 111, 114, 116, 95, 109, 105, 110, 116]),
        ),
        getAddressEncoder().encode(expectAddress(accounts.optionAccount.value)),
      ],
    });
  }
  if (!accounts.mintAuthority.value) {
    accounts.mintAuthority.value = await getProgramDerivedAddress({
      programAddress,
      seeds: [
        getBytesEncoder().encode(
          new Uint8Array([
            109, 105, 110, 116, 95, 97, 117, 116, 104, 111, 114, 105, 116, 121,
          ]),
        ),
      ],
    });
  }
  if (!accounts.makerLongAccount.value) {
    accounts.makerLongAccount.value = await getProgramDerivedAddress({
      programAddress:
        "ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL" as Address<"ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL">,
      seeds: [
        getAddressEncoder().encode(expectAddress(accounts.maker.value)),
        getBytesEncoder().encode(
          new Uint8Array([
            6, 221, 246, 225, 215, 101, 161, 147, 217, 203, 225, 70, 206, 235,
            121, 172, 28, 180, 133, 237, 95, 91, 55, 145, 58, 140, 245, 133,
            126, 255, 0, 169,
          ]),
        ),
        getAddressEncoder().encode(expectAddress(accounts.longMint.value)),
      ],
    });
  }
  if (!accounts.makerShortAccount.value) {
    accounts.makerShortAccount.value = await getProgramDerivedAddress({
      programAddress:
        "ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL" as Address<"ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL">,
      seeds: [
        getAddressEncoder().encode(expectAddress(accounts.maker.value)),
        getBytesEncoder().encode(
          new Uint8Array([
            6, 221, 246, 225, 215, 101, 161, 147, 217, 203, 225, 70, 206, 235,
            121, 172, 28, 180, 133, 237, 95, 91, 55, 145, 58, 140, 245, 133,
            126, 255, 0, 169,
          ]),
        ),
        getAddressEncoder().encode(expectAddress(accounts.shortMint.value)),
      ],
    });
  }
  if (!accounts.marketData.value) {
    accounts.marketData.value = await getProgramDerivedAddress({
      programAddress,
      seeds: [
        getBytesEncoder().encode(
          new Uint8Array([109, 97, 114, 107, 101, 116, 95, 100, 97, 116, 97]),
        ),
        getAddressEncoder().encode(expectSome(args.underlyingAsset)),
      ],
    });
  }
  if (!accounts.optionPool.value) {
    accounts.optionPool.value = await getProgramDerivedAddress({
      programAddress,
      seeds: [
        getBytesEncoder().encode(
          new Uint8Array([
            111, 112, 116, 105, 111, 110, 95, 112, 111, 111, 108,
          ]),
        ),
        getAddressEncoder().encode(expectAddress(accounts.optionAccount.value)),
      ],
    });
  }
  if (!accounts.escrowLongAccount.value) {
    accounts.escrowLongAccount.value = await getProgramDerivedAddress({
      programAddress:
        "ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL" as Address<"ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL">,
      seeds: [
        getAddressEncoder().encode(expectAddress(accounts.optionPool.value)),
        getBytesEncoder().encode(
          new Uint8Array([
            6, 221, 246, 225, 215, 101, 161, 147, 217, 203, 225, 70, 206, 235,
            121, 172, 28, 180, 133, 237, 95, 91, 55, 145, 58, 140, 245, 133,
            126, 255, 0, 169,
          ]),
        ),
        getAddressEncoder().encode(expectAddress(accounts.longMint.value)),
      ],
    });
  }
  if (!accounts.premiumVault.value) {
    accounts.premiumVault.value = await getProgramDerivedAddress({
      programAddress:
        "ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL" as Address<"ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL">,
      seeds: [
        getAddressEncoder().encode(expectAddress(accounts.optionPool.value)),
        getBytesEncoder().encode(
          new Uint8Array([
            6, 221, 246, 225, 215, 101, 161, 147, 217, 203, 225, 70, 206, 235,
            121, 172, 28, 180, 133, 237, 95, 91, 55, 145, 58, 140, 245, 133,
            126, 255, 0, 169,
          ]),
        ),
        getAddressEncoder().encode(
          expectAddress(accounts.underlyingMint.value),
        ),
      ],
    });
  }
  if (!accounts.collateralPool.value) {
    accounts.collateralPool.value = await getProgramDerivedAddress({
      programAddress,
      seeds: [
        getBytesEncoder().encode(
          new Uint8Array([
            99, 111, 108, 108, 97, 116, 101, 114, 97, 108, 95, 112, 111, 111,
            108,
          ]),
        ),
        getAddressEncoder().encode(expectAddress(accounts.optionAccount.value)),
      ],
    });
  }
  if (!accounts.collateralVault.value) {
    accounts.collateralVault.value = await getProgramDerivedAddress({
      programAddress:
        "ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL" as Address<"ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL">,
      seeds: [
        getAddressEncoder().encode(
          expectAddress(accounts.collateralPool.value),
        ),
        getBytesEncoder().encode(
          new Uint8Array([
            6, 221, 246, 225, 215, 101, 161, 147, 217, 203, 225, 70, 206, 235,
            121, 172, 28, 180, 133, 237, 95, 91, 55, 145, 58, 140, 245, 133,
            126, 255, 0, 169,
          ]),
        ),
        getAddressEncoder().encode(
          expectAddress(accounts.underlyingMint.value),
        ),
      ],
    });
  }
  if (!accounts.writerPosition.value) {
    accounts.writerPosition.value = await getProgramDerivedAddress({
      programAddress,
      seeds: [
        getBytesEncoder().encode(
          new Uint8Array([
            119, 114, 105, 116, 101, 114, 95, 112, 111, 115, 105, 116, 105, 111,
            110,
          ]),
        ),
        getAddressEncoder().encode(expectAddress(accounts.optionPool.value)),
        getAddressEncoder().encode(expectAddress(accounts.maker.value)),
      ],
    });
  }
  if (!accounts.tokenProgram.value) {
    accounts.tokenProgram.value =
      "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA" as Address<"TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA">;
  }
  if (!accounts.associatedTokenProgram.value) {
    accounts.associatedTokenProgram.value =
      "ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL" as Address<"ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL">;
  }
  if (!accounts.tokenMetadataProgram.value) {
    accounts.tokenMetadataProgram.value =
      "metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s" as Address<"metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s">;
  }
  if (!accounts.systemProgram.value) {
    accounts.systemProgram.value =
      "11111111111111111111111111111111" as Address<"11111111111111111111111111111111">;
  }
  if (!accounts.rent.value) {
    accounts.rent.value =
      "SysvarRent111111111111111111111111111111111" as Address<"SysvarRent111111111111111111111111111111111">;
  }

  const getAccountMeta = getAccountMetaFactory(programAddress, "programId");
  return Object.freeze({
    accounts: [
      getAccountMeta(accounts.optionAccount),
      getAccountMeta(accounts.longMint),
      getAccountMeta(accounts.shortMint),
      getAccountMeta(accounts.mintAuthority),
      getAccountMeta(accounts.makerLongAccount),
      getAccountMeta(accounts.makerShortAccount),
      getAccountMeta(accounts.longMetadataAccount),
      getAccountMeta(accounts.shortMetadataAccount),
      getAccountMeta(accounts.marketData),
      getAccountMeta(accounts.underlyingMint),
      getAccountMeta(accounts.optionPool),
      getAccountMeta(accounts.escrowLongAccount),
      getAccountMeta(accounts.premiumVault),
      getAccountMeta(accounts.collateralPool),
      getAccountMeta(accounts.collateralVault),
      getAccountMeta(accounts.makerCollateralAccount),
      getAccountMeta(accounts.writerPosition),
      getAccountMeta(accounts.vault),
      getAccountMeta(accounts.vaultTokenAccount),
      getAccountMeta(accounts.escrowState),
      getAccountMeta(accounts.escrowAuthority),
      getAccountMeta(accounts.escrowTokenAccount),
      getAccountMeta(accounts.poolLoan),
      getAccountMeta(accounts.maker),
      getAccountMeta(accounts.tokenProgram),
      getAccountMeta(accounts.associatedTokenProgram),
      getAccountMeta(accounts.tokenMetadataProgram),
      getAccountMeta(accounts.systemProgram),
      getAccountMeta(accounts.rent),
    ],
    data: getOptionMintInstructionDataEncoder().encode(
      args as OptionMintInstructionDataArgs,
    ),
    programAddress,
  } as OptionMintInstruction<
    TProgramAddress,
    TAccountOptionAccount,
    TAccountLongMint,
    TAccountShortMint,
    TAccountMintAuthority,
    TAccountMakerLongAccount,
    TAccountMakerShortAccount,
    TAccountLongMetadataAccount,
    TAccountShortMetadataAccount,
    TAccountMarketData,
    TAccountUnderlyingMint,
    TAccountOptionPool,
    TAccountEscrowLongAccount,
    TAccountPremiumVault,
    TAccountCollateralPool,
    TAccountCollateralVault,
    TAccountMakerCollateralAccount,
    TAccountWriterPosition,
    TAccountVault,
    TAccountVaultTokenAccount,
    TAccountEscrowState,
    TAccountEscrowAuthority,
    TAccountEscrowTokenAccount,
    TAccountPoolLoan,
    TAccountMaker,
    TAccountTokenProgram,
    TAccountAssociatedTokenProgram,
    TAccountTokenMetadataProgram,
    TAccountSystemProgram,
    TAccountRent
  >);
}

export type OptionMintInput<
  TAccountOptionAccount extends string = string,
  TAccountLongMint extends string = string,
  TAccountShortMint extends string = string,
  TAccountMintAuthority extends string = string,
  TAccountMakerLongAccount extends string = string,
  TAccountMakerShortAccount extends string = string,
  TAccountLongMetadataAccount extends string = string,
  TAccountShortMetadataAccount extends string = string,
  TAccountMarketData extends string = string,
  TAccountUnderlyingMint extends string = string,
  TAccountOptionPool extends string = string,
  TAccountEscrowLongAccount extends string = string,
  TAccountPremiumVault extends string = string,
  TAccountCollateralPool extends string = string,
  TAccountCollateralVault extends string = string,
  TAccountMakerCollateralAccount extends string = string,
  TAccountWriterPosition extends string = string,
  TAccountVault extends string = string,
  TAccountVaultTokenAccount extends string = string,
  TAccountEscrowState extends string = string,
  TAccountEscrowAuthority extends string = string,
  TAccountEscrowTokenAccount extends string = string,
  TAccountPoolLoan extends string = string,
  TAccountMaker extends string = string,
  TAccountTokenProgram extends string = string,
  TAccountAssociatedTokenProgram extends string = string,
  TAccountTokenMetadataProgram extends string = string,
  TAccountSystemProgram extends string = string,
  TAccountRent extends string = string,
> = {
  /**
   * Option account - derived from option parameters (NOT maker)
   * Uses init_if_needed so multiple makers can use the same option
   */
  optionAccount: Address<TAccountOptionAccount>;
  /**
   * LONG token mint - one per unique option parameters (buyers hold these)
   * Uses init_if_needed so multiple makers share the same token
   */
  longMint: Address<TAccountLongMint>;
  /**
   * SHORT token mint - one per unique option parameters (writers hold these)
   * Uses init_if_needed so multiple makers share the same token
   */
  shortMint: Address<TAccountShortMint>;
  mintAuthority: Address<TAccountMintAuthority>;
  /** Maker's LONG token account (receives LONG tokens to deposit in pool) */
  makerLongAccount: Address<TAccountMakerLongAccount>;
  /** Maker's SHORT token account (receives SHORT tokens as proof of writing) */
  makerShortAccount: Address<TAccountMakerShortAccount>;
  longMetadataAccount: Address<TAccountLongMetadataAccount>;
  shortMetadataAccount: Address<TAccountShortMetadataAccount>;
  /** Market data account - provides baseline historical volatility for initial IV */
  marketData: Address<TAccountMarketData>;
  /** Underlying asset mint (e.g., WSOL) - required for collateral and pool initialization */
  underlyingMint: Address<TAccountUnderlyingMint>;
  /** Option pool - aggregated liquidity pool for this option */
  optionPool: Address<TAccountOptionPool>;
  /** Pool's escrow for holding LONG tokens (for buyers to purchase) */
  escrowLongAccount: Address<TAccountEscrowLongAccount>;
  /** Pool's vault for collecting premiums (in underlying asset) */
  premiumVault: Address<TAccountPremiumVault>;
  /** Collateral pool for this option */
  collateralPool: Address<TAccountCollateralPool>;
  /** Collateral vault (ATA holding collateral) */
  collateralVault: Address<TAccountCollateralVault>;
  /** Maker's collateral account (source of maker's own collateral) */
  makerCollateralAccount: Address<TAccountMakerCollateralAccount>;
  /** Writer's unified position account (single source of truth) */
  writerPosition: Address<TAccountWriterPosition>;
  /** OMLP vault (optional - only required if borrowing) */
  vault?: Address<TAccountVault>;
  /** Vault's token account (optional - only required if borrowing) */
  vaultTokenAccount?: Address<TAccountVaultTokenAccount>;
  /** Escrow state PDA (optional - only required if borrowing) */
  escrowState?: Address<TAccountEscrowState>;
  /** Escrow authority PDA (optional - only required if borrowing) */
  escrowAuthority?: Address<TAccountEscrowAuthority>;
  /** Escrow token account (optional - only required if borrowing) */
  escrowTokenAccount?: Address<TAccountEscrowTokenAccount>;
  /** Pool loan account (optional - only required if borrowing) */
  poolLoan?: Address<TAccountPoolLoan>;
  maker: TransactionSigner<TAccountMaker>;
  tokenProgram?: Address<TAccountTokenProgram>;
  associatedTokenProgram?: Address<TAccountAssociatedTokenProgram>;
  tokenMetadataProgram?: Address<TAccountTokenMetadataProgram>;
  systemProgram?: Address<TAccountSystemProgram>;
  rent?: Address<TAccountRent>;
  optionType: OptionMintInstructionDataArgs["optionType"];
  strikePrice: OptionMintInstructionDataArgs["strikePrice"];
  expirationDate: OptionMintInstructionDataArgs["expirationDate"];
  quantity: OptionMintInstructionDataArgs["quantity"];
  underlyingAsset: OptionMintInstructionDataArgs["underlyingAsset"];
  underlyingSymbol: OptionMintInstructionDataArgs["underlyingSymbol"];
  makerCollateralAmount: OptionMintInstructionDataArgs["makerCollateralAmount"];
  borrowedAmount: OptionMintInstructionDataArgs["borrowedAmount"];
};

export function getOptionMintInstruction<
  TAccountOptionAccount extends string,
  TAccountLongMint extends string,
  TAccountShortMint extends string,
  TAccountMintAuthority extends string,
  TAccountMakerLongAccount extends string,
  TAccountMakerShortAccount extends string,
  TAccountLongMetadataAccount extends string,
  TAccountShortMetadataAccount extends string,
  TAccountMarketData extends string,
  TAccountUnderlyingMint extends string,
  TAccountOptionPool extends string,
  TAccountEscrowLongAccount extends string,
  TAccountPremiumVault extends string,
  TAccountCollateralPool extends string,
  TAccountCollateralVault extends string,
  TAccountMakerCollateralAccount extends string,
  TAccountWriterPosition extends string,
  TAccountVault extends string,
  TAccountVaultTokenAccount extends string,
  TAccountEscrowState extends string,
  TAccountEscrowAuthority extends string,
  TAccountEscrowTokenAccount extends string,
  TAccountPoolLoan extends string,
  TAccountMaker extends string,
  TAccountTokenProgram extends string,
  TAccountAssociatedTokenProgram extends string,
  TAccountTokenMetadataProgram extends string,
  TAccountSystemProgram extends string,
  TAccountRent extends string,
  TProgramAddress extends Address = typeof OPTION_PROGRAM_PROGRAM_ADDRESS,
>(
  input: OptionMintInput<
    TAccountOptionAccount,
    TAccountLongMint,
    TAccountShortMint,
    TAccountMintAuthority,
    TAccountMakerLongAccount,
    TAccountMakerShortAccount,
    TAccountLongMetadataAccount,
    TAccountShortMetadataAccount,
    TAccountMarketData,
    TAccountUnderlyingMint,
    TAccountOptionPool,
    TAccountEscrowLongAccount,
    TAccountPremiumVault,
    TAccountCollateralPool,
    TAccountCollateralVault,
    TAccountMakerCollateralAccount,
    TAccountWriterPosition,
    TAccountVault,
    TAccountVaultTokenAccount,
    TAccountEscrowState,
    TAccountEscrowAuthority,
    TAccountEscrowTokenAccount,
    TAccountPoolLoan,
    TAccountMaker,
    TAccountTokenProgram,
    TAccountAssociatedTokenProgram,
    TAccountTokenMetadataProgram,
    TAccountSystemProgram,
    TAccountRent
  >,
  config?: { programAddress?: TProgramAddress },
): OptionMintInstruction<
  TProgramAddress,
  TAccountOptionAccount,
  TAccountLongMint,
  TAccountShortMint,
  TAccountMintAuthority,
  TAccountMakerLongAccount,
  TAccountMakerShortAccount,
  TAccountLongMetadataAccount,
  TAccountShortMetadataAccount,
  TAccountMarketData,
  TAccountUnderlyingMint,
  TAccountOptionPool,
  TAccountEscrowLongAccount,
  TAccountPremiumVault,
  TAccountCollateralPool,
  TAccountCollateralVault,
  TAccountMakerCollateralAccount,
  TAccountWriterPosition,
  TAccountVault,
  TAccountVaultTokenAccount,
  TAccountEscrowState,
  TAccountEscrowAuthority,
  TAccountEscrowTokenAccount,
  TAccountPoolLoan,
  TAccountMaker,
  TAccountTokenProgram,
  TAccountAssociatedTokenProgram,
  TAccountTokenMetadataProgram,
  TAccountSystemProgram,
  TAccountRent
> {
  // Program address.
  const programAddress =
    config?.programAddress ?? OPTION_PROGRAM_PROGRAM_ADDRESS;

  // Original accounts.
  const originalAccounts = {
    optionAccount: { value: input.optionAccount ?? null, isWritable: true },
    longMint: { value: input.longMint ?? null, isWritable: true },
    shortMint: { value: input.shortMint ?? null, isWritable: true },
    mintAuthority: { value: input.mintAuthority ?? null, isWritable: false },
    makerLongAccount: {
      value: input.makerLongAccount ?? null,
      isWritable: true,
    },
    makerShortAccount: {
      value: input.makerShortAccount ?? null,
      isWritable: true,
    },
    longMetadataAccount: {
      value: input.longMetadataAccount ?? null,
      isWritable: true,
    },
    shortMetadataAccount: {
      value: input.shortMetadataAccount ?? null,
      isWritable: true,
    },
    marketData: { value: input.marketData ?? null, isWritable: false },
    underlyingMint: { value: input.underlyingMint ?? null, isWritable: false },
    optionPool: { value: input.optionPool ?? null, isWritable: true },
    escrowLongAccount: {
      value: input.escrowLongAccount ?? null,
      isWritable: true,
    },
    premiumVault: { value: input.premiumVault ?? null, isWritable: true },
    collateralPool: { value: input.collateralPool ?? null, isWritable: true },
    collateralVault: { value: input.collateralVault ?? null, isWritable: true },
    makerCollateralAccount: {
      value: input.makerCollateralAccount ?? null,
      isWritable: true,
    },
    writerPosition: { value: input.writerPosition ?? null, isWritable: true },
    vault: { value: input.vault ?? null, isWritable: true },
    vaultTokenAccount: {
      value: input.vaultTokenAccount ?? null,
      isWritable: true,
    },
    escrowState: { value: input.escrowState ?? null, isWritable: true },
    escrowAuthority: {
      value: input.escrowAuthority ?? null,
      isWritable: false,
    },
    escrowTokenAccount: {
      value: input.escrowTokenAccount ?? null,
      isWritable: true,
    },
    poolLoan: { value: input.poolLoan ?? null, isWritable: true },
    maker: { value: input.maker ?? null, isWritable: true },
    tokenProgram: { value: input.tokenProgram ?? null, isWritable: false },
    associatedTokenProgram: {
      value: input.associatedTokenProgram ?? null,
      isWritable: false,
    },
    tokenMetadataProgram: {
      value: input.tokenMetadataProgram ?? null,
      isWritable: false,
    },
    systemProgram: { value: input.systemProgram ?? null, isWritable: false },
    rent: { value: input.rent ?? null, isWritable: false },
  };
  const accounts = originalAccounts as Record<
    keyof typeof originalAccounts,
    ResolvedAccount
  >;

  // Original args.
  const args = { ...input };

  // Resolve default values.
  if (!accounts.tokenProgram.value) {
    accounts.tokenProgram.value =
      "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA" as Address<"TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA">;
  }
  if (!accounts.associatedTokenProgram.value) {
    accounts.associatedTokenProgram.value =
      "ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL" as Address<"ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL">;
  }
  if (!accounts.tokenMetadataProgram.value) {
    accounts.tokenMetadataProgram.value =
      "metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s" as Address<"metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s">;
  }
  if (!accounts.systemProgram.value) {
    accounts.systemProgram.value =
      "11111111111111111111111111111111" as Address<"11111111111111111111111111111111">;
  }
  if (!accounts.rent.value) {
    accounts.rent.value =
      "SysvarRent111111111111111111111111111111111" as Address<"SysvarRent111111111111111111111111111111111">;
  }

  const getAccountMeta = getAccountMetaFactory(programAddress, "programId");
  return Object.freeze({
    accounts: [
      getAccountMeta(accounts.optionAccount),
      getAccountMeta(accounts.longMint),
      getAccountMeta(accounts.shortMint),
      getAccountMeta(accounts.mintAuthority),
      getAccountMeta(accounts.makerLongAccount),
      getAccountMeta(accounts.makerShortAccount),
      getAccountMeta(accounts.longMetadataAccount),
      getAccountMeta(accounts.shortMetadataAccount),
      getAccountMeta(accounts.marketData),
      getAccountMeta(accounts.underlyingMint),
      getAccountMeta(accounts.optionPool),
      getAccountMeta(accounts.escrowLongAccount),
      getAccountMeta(accounts.premiumVault),
      getAccountMeta(accounts.collateralPool),
      getAccountMeta(accounts.collateralVault),
      getAccountMeta(accounts.makerCollateralAccount),
      getAccountMeta(accounts.writerPosition),
      getAccountMeta(accounts.vault),
      getAccountMeta(accounts.vaultTokenAccount),
      getAccountMeta(accounts.escrowState),
      getAccountMeta(accounts.escrowAuthority),
      getAccountMeta(accounts.escrowTokenAccount),
      getAccountMeta(accounts.poolLoan),
      getAccountMeta(accounts.maker),
      getAccountMeta(accounts.tokenProgram),
      getAccountMeta(accounts.associatedTokenProgram),
      getAccountMeta(accounts.tokenMetadataProgram),
      getAccountMeta(accounts.systemProgram),
      getAccountMeta(accounts.rent),
    ],
    data: getOptionMintInstructionDataEncoder().encode(
      args as OptionMintInstructionDataArgs,
    ),
    programAddress,
  } as OptionMintInstruction<
    TProgramAddress,
    TAccountOptionAccount,
    TAccountLongMint,
    TAccountShortMint,
    TAccountMintAuthority,
    TAccountMakerLongAccount,
    TAccountMakerShortAccount,
    TAccountLongMetadataAccount,
    TAccountShortMetadataAccount,
    TAccountMarketData,
    TAccountUnderlyingMint,
    TAccountOptionPool,
    TAccountEscrowLongAccount,
    TAccountPremiumVault,
    TAccountCollateralPool,
    TAccountCollateralVault,
    TAccountMakerCollateralAccount,
    TAccountWriterPosition,
    TAccountVault,
    TAccountVaultTokenAccount,
    TAccountEscrowState,
    TAccountEscrowAuthority,
    TAccountEscrowTokenAccount,
    TAccountPoolLoan,
    TAccountMaker,
    TAccountTokenProgram,
    TAccountAssociatedTokenProgram,
    TAccountTokenMetadataProgram,
    TAccountSystemProgram,
    TAccountRent
  >);
}

export type ParsedOptionMintInstruction<
  TProgram extends string = typeof OPTION_PROGRAM_PROGRAM_ADDRESS,
  TAccountMetas extends readonly AccountMeta[] = readonly AccountMeta[],
> = {
  programAddress: Address<TProgram>;
  accounts: {
    /**
     * Option account - derived from option parameters (NOT maker)
     * Uses init_if_needed so multiple makers can use the same option
     */
    optionAccount: TAccountMetas[0];
    /**
     * LONG token mint - one per unique option parameters (buyers hold these)
     * Uses init_if_needed so multiple makers share the same token
     */
    longMint: TAccountMetas[1];
    /**
     * SHORT token mint - one per unique option parameters (writers hold these)
     * Uses init_if_needed so multiple makers share the same token
     */
    shortMint: TAccountMetas[2];
    mintAuthority: TAccountMetas[3];
    /** Maker's LONG token account (receives LONG tokens to deposit in pool) */
    makerLongAccount: TAccountMetas[4];
    /** Maker's SHORT token account (receives SHORT tokens as proof of writing) */
    makerShortAccount: TAccountMetas[5];
    longMetadataAccount: TAccountMetas[6];
    shortMetadataAccount: TAccountMetas[7];
    /** Market data account - provides baseline historical volatility for initial IV */
    marketData: TAccountMetas[8];
    /** Underlying asset mint (e.g., WSOL) - required for collateral and pool initialization */
    underlyingMint: TAccountMetas[9];
    /** Option pool - aggregated liquidity pool for this option */
    optionPool: TAccountMetas[10];
    /** Pool's escrow for holding LONG tokens (for buyers to purchase) */
    escrowLongAccount: TAccountMetas[11];
    /** Pool's vault for collecting premiums (in underlying asset) */
    premiumVault: TAccountMetas[12];
    /** Collateral pool for this option */
    collateralPool: TAccountMetas[13];
    /** Collateral vault (ATA holding collateral) */
    collateralVault: TAccountMetas[14];
    /** Maker's collateral account (source of maker's own collateral) */
    makerCollateralAccount: TAccountMetas[15];
    /** Writer's unified position account (single source of truth) */
    writerPosition: TAccountMetas[16];
    /** OMLP vault (optional - only required if borrowing) */
    vault?: TAccountMetas[17] | undefined;
    /** Vault's token account (optional - only required if borrowing) */
    vaultTokenAccount?: TAccountMetas[18] | undefined;
    /** Escrow state PDA (optional - only required if borrowing) */
    escrowState?: TAccountMetas[19] | undefined;
    /** Escrow authority PDA (optional - only required if borrowing) */
    escrowAuthority?: TAccountMetas[20] | undefined;
    /** Escrow token account (optional - only required if borrowing) */
    escrowTokenAccount?: TAccountMetas[21] | undefined;
    /** Pool loan account (optional - only required if borrowing) */
    poolLoan?: TAccountMetas[22] | undefined;
    maker: TAccountMetas[23];
    tokenProgram: TAccountMetas[24];
    associatedTokenProgram: TAccountMetas[25];
    tokenMetadataProgram: TAccountMetas[26];
    systemProgram: TAccountMetas[27];
    rent: TAccountMetas[28];
  };
  data: OptionMintInstructionData;
};

export function parseOptionMintInstruction<
  TProgram extends string,
  TAccountMetas extends readonly AccountMeta[],
>(
  instruction: Instruction<TProgram> &
    InstructionWithAccounts<TAccountMetas> &
    InstructionWithData<ReadonlyUint8Array>,
): ParsedOptionMintInstruction<TProgram, TAccountMetas> {
  if (instruction.accounts.length < 29) {
    // TODO: Coded error.
    throw new Error("Not enough accounts");
  }
  let accountIndex = 0;
  const getNextAccount = () => {
    const accountMeta = (instruction.accounts as TAccountMetas)[accountIndex]!;
    accountIndex += 1;
    return accountMeta;
  };
  const getNextOptionalAccount = () => {
    const accountMeta = getNextAccount();
    return accountMeta.address === OPTION_PROGRAM_PROGRAM_ADDRESS
      ? undefined
      : accountMeta;
  };
  return {
    programAddress: instruction.programAddress,
    accounts: {
      optionAccount: getNextAccount(),
      longMint: getNextAccount(),
      shortMint: getNextAccount(),
      mintAuthority: getNextAccount(),
      makerLongAccount: getNextAccount(),
      makerShortAccount: getNextAccount(),
      longMetadataAccount: getNextAccount(),
      shortMetadataAccount: getNextAccount(),
      marketData: getNextAccount(),
      underlyingMint: getNextAccount(),
      optionPool: getNextAccount(),
      escrowLongAccount: getNextAccount(),
      premiumVault: getNextAccount(),
      collateralPool: getNextAccount(),
      collateralVault: getNextAccount(),
      makerCollateralAccount: getNextAccount(),
      writerPosition: getNextAccount(),
      vault: getNextOptionalAccount(),
      vaultTokenAccount: getNextOptionalAccount(),
      escrowState: getNextOptionalAccount(),
      escrowAuthority: getNextOptionalAccount(),
      escrowTokenAccount: getNextOptionalAccount(),
      poolLoan: getNextOptionalAccount(),
      maker: getNextAccount(),
      tokenProgram: getNextAccount(),
      associatedTokenProgram: getNextAccount(),
      tokenMetadataProgram: getNextAccount(),
      systemProgram: getNextAccount(),
      rent: getNextAccount(),
    },
    data: getOptionMintInstructionDataDecoder().decode(instruction.data),
  };
}
