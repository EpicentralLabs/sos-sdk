/**
 * This code was AUTOGENERATED using the Codama library.
 * Please DO NOT EDIT THIS FILE, instead use visitors
 * to add features, then rerun Codama to update it.
 *
 * @see https://github.com/codama-idl/codama
 */

import {
  combineCodec,
  fixDecoderSize,
  fixEncoderSize,
  getAddressEncoder,
  getBytesDecoder,
  getBytesEncoder,
  getProgramDerivedAddress,
  getStructDecoder,
  getStructEncoder,
  getU64Decoder,
  getU64Encoder,
  transformEncoder,
  type AccountMeta,
  type AccountSignerMeta,
  type Address,
  type FixedSizeCodec,
  type FixedSizeDecoder,
  type FixedSizeEncoder,
  type Instruction,
  type InstructionWithAccounts,
  type InstructionWithData,
  type ReadonlyAccount,
  type ReadonlyUint8Array,
  type TransactionSigner,
  type WritableAccount,
  type WritableSignerAccount,
} from "@solana/kit";
import { OPTION_PROGRAM_PROGRAM_ADDRESS } from "../programs";
import {
  expectAddress,
  getAccountMetaFactory,
  type ResolvedAccount,
} from "../shared";

export const WRITE_TO_POOL_DISCRIMINATOR = new Uint8Array([
  169, 94, 104, 228, 81, 205, 147, 71,
]);

export function getWriteToPoolDiscriminatorBytes() {
  return fixEncoderSize(getBytesEncoder(), 8).encode(
    WRITE_TO_POOL_DISCRIMINATOR,
  );
}

export type WriteToPoolInstruction<
  TProgram extends string = typeof OPTION_PROGRAM_PROGRAM_ADDRESS,
  TAccountOptionPool extends string | AccountMeta<string> = string,
  TAccountOptionAccount extends string | AccountMeta<string> = string,
  TAccountCollateralPool extends string | AccountMeta<string> = string,
  TAccountWriterPosition extends string | AccountMeta<string> = string,
  TAccountWriterLongAccount extends string | AccountMeta<string> = string,
  TAccountWriterShortAccount extends string | AccountMeta<string> = string,
  TAccountWriterCollateralAccount extends string | AccountMeta<string> = string,
  TAccountEscrowLongAccount extends string | AccountMeta<string> = string,
  TAccountCollateralVault extends string | AccountMeta<string> = string,
  TAccountWriter extends string | AccountMeta<string> = string,
  TAccountTokenProgram extends string | AccountMeta<string> =
    "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA",
  TAccountSystemProgram extends string | AccountMeta<string> =
    "11111111111111111111111111111111",
  TRemainingAccounts extends readonly AccountMeta<string>[] = [],
> = Instruction<TProgram> &
  InstructionWithData<ReadonlyUint8Array> &
  InstructionWithAccounts<
    [
      TAccountOptionPool extends string
        ? WritableAccount<TAccountOptionPool>
        : TAccountOptionPool,
      TAccountOptionAccount extends string
        ? WritableAccount<TAccountOptionAccount>
        : TAccountOptionAccount,
      TAccountCollateralPool extends string
        ? WritableAccount<TAccountCollateralPool>
        : TAccountCollateralPool,
      TAccountWriterPosition extends string
        ? WritableAccount<TAccountWriterPosition>
        : TAccountWriterPosition,
      TAccountWriterLongAccount extends string
        ? WritableAccount<TAccountWriterLongAccount>
        : TAccountWriterLongAccount,
      TAccountWriterShortAccount extends string
        ? ReadonlyAccount<TAccountWriterShortAccount>
        : TAccountWriterShortAccount,
      TAccountWriterCollateralAccount extends string
        ? WritableAccount<TAccountWriterCollateralAccount>
        : TAccountWriterCollateralAccount,
      TAccountEscrowLongAccount extends string
        ? WritableAccount<TAccountEscrowLongAccount>
        : TAccountEscrowLongAccount,
      TAccountCollateralVault extends string
        ? WritableAccount<TAccountCollateralVault>
        : TAccountCollateralVault,
      TAccountWriter extends string
        ? WritableSignerAccount<TAccountWriter> &
            AccountSignerMeta<TAccountWriter>
        : TAccountWriter,
      TAccountTokenProgram extends string
        ? ReadonlyAccount<TAccountTokenProgram>
        : TAccountTokenProgram,
      TAccountSystemProgram extends string
        ? ReadonlyAccount<TAccountSystemProgram>
        : TAccountSystemProgram,
      ...TRemainingAccounts,
    ]
  >;

export type WriteToPoolInstructionData = {
  discriminator: ReadonlyUint8Array;
  longQty: bigint;
  collateralAmount: bigint;
};

export type WriteToPoolInstructionDataArgs = {
  longQty: number | bigint;
  collateralAmount: number | bigint;
};

export function getWriteToPoolInstructionDataEncoder(): FixedSizeEncoder<WriteToPoolInstructionDataArgs> {
  return transformEncoder(
    getStructEncoder([
      ["discriminator", fixEncoderSize(getBytesEncoder(), 8)],
      ["longQty", getU64Encoder()],
      ["collateralAmount", getU64Encoder()],
    ]),
    (value) => ({ ...value, discriminator: WRITE_TO_POOL_DISCRIMINATOR }),
  );
}

export function getWriteToPoolInstructionDataDecoder(): FixedSizeDecoder<WriteToPoolInstructionData> {
  return getStructDecoder([
    ["discriminator", fixDecoderSize(getBytesDecoder(), 8)],
    ["longQty", getU64Decoder()],
    ["collateralAmount", getU64Decoder()],
  ]);
}

export function getWriteToPoolInstructionDataCodec(): FixedSizeCodec<
  WriteToPoolInstructionDataArgs,
  WriteToPoolInstructionData
> {
  return combineCodec(
    getWriteToPoolInstructionDataEncoder(),
    getWriteToPoolInstructionDataDecoder(),
  );
}

export type WriteToPoolAsyncInput<
  TAccountOptionPool extends string = string,
  TAccountOptionAccount extends string = string,
  TAccountCollateralPool extends string = string,
  TAccountWriterPosition extends string = string,
  TAccountWriterLongAccount extends string = string,
  TAccountWriterShortAccount extends string = string,
  TAccountWriterCollateralAccount extends string = string,
  TAccountEscrowLongAccount extends string = string,
  TAccountCollateralVault extends string = string,
  TAccountWriter extends string = string,
  TAccountTokenProgram extends string = string,
  TAccountSystemProgram extends string = string,
> = {
  /** The pool to write into */
  optionPool: Address<TAccountOptionPool>;
  /** The option account */
  optionAccount: Address<TAccountOptionAccount>;
  /** Collateral pool for this option */
  collateralPool?: Address<TAccountCollateralPool>;
  /** Writer's unified position account (single source of truth) */
  writerPosition?: Address<TAccountWriterPosition>;
  /** Writer's LONG token account (source - depositing to pool) */
  writerLongAccount: Address<TAccountWriterLongAccount>;
  /** Writer's SHORT token account (already holds SHORT from minting) */
  writerShortAccount: Address<TAccountWriterShortAccount>;
  /** Writer's collateral account (source of own collateral) */
  writerCollateralAccount: Address<TAccountWriterCollateralAccount>;
  /** Pool's LONG escrow (destination for LONG tokens) */
  escrowLongAccount: Address<TAccountEscrowLongAccount>;
  /** Pool's collateral vault (destination for collateral) */
  collateralVault: Address<TAccountCollateralVault>;
  writer: TransactionSigner<TAccountWriter>;
  tokenProgram?: Address<TAccountTokenProgram>;
  systemProgram?: Address<TAccountSystemProgram>;
  longQty: WriteToPoolInstructionDataArgs["longQty"];
  collateralAmount: WriteToPoolInstructionDataArgs["collateralAmount"];
};

export async function getWriteToPoolInstructionAsync<
  TAccountOptionPool extends string,
  TAccountOptionAccount extends string,
  TAccountCollateralPool extends string,
  TAccountWriterPosition extends string,
  TAccountWriterLongAccount extends string,
  TAccountWriterShortAccount extends string,
  TAccountWriterCollateralAccount extends string,
  TAccountEscrowLongAccount extends string,
  TAccountCollateralVault extends string,
  TAccountWriter extends string,
  TAccountTokenProgram extends string,
  TAccountSystemProgram extends string,
  TProgramAddress extends Address = typeof OPTION_PROGRAM_PROGRAM_ADDRESS,
>(
  input: WriteToPoolAsyncInput<
    TAccountOptionPool,
    TAccountOptionAccount,
    TAccountCollateralPool,
    TAccountWriterPosition,
    TAccountWriterLongAccount,
    TAccountWriterShortAccount,
    TAccountWriterCollateralAccount,
    TAccountEscrowLongAccount,
    TAccountCollateralVault,
    TAccountWriter,
    TAccountTokenProgram,
    TAccountSystemProgram
  >,
  config?: { programAddress?: TProgramAddress },
): Promise<
  WriteToPoolInstruction<
    TProgramAddress,
    TAccountOptionPool,
    TAccountOptionAccount,
    TAccountCollateralPool,
    TAccountWriterPosition,
    TAccountWriterLongAccount,
    TAccountWriterShortAccount,
    TAccountWriterCollateralAccount,
    TAccountEscrowLongAccount,
    TAccountCollateralVault,
    TAccountWriter,
    TAccountTokenProgram,
    TAccountSystemProgram
  >
> {
  // Program address.
  const programAddress =
    config?.programAddress ?? OPTION_PROGRAM_PROGRAM_ADDRESS;

  // Original accounts.
  const originalAccounts = {
    optionPool: { value: input.optionPool ?? null, isWritable: true },
    optionAccount: { value: input.optionAccount ?? null, isWritable: true },
    collateralPool: { value: input.collateralPool ?? null, isWritable: true },
    writerPosition: { value: input.writerPosition ?? null, isWritable: true },
    writerLongAccount: {
      value: input.writerLongAccount ?? null,
      isWritable: true,
    },
    writerShortAccount: {
      value: input.writerShortAccount ?? null,
      isWritable: false,
    },
    writerCollateralAccount: {
      value: input.writerCollateralAccount ?? null,
      isWritable: true,
    },
    escrowLongAccount: {
      value: input.escrowLongAccount ?? null,
      isWritable: true,
    },
    collateralVault: { value: input.collateralVault ?? null, isWritable: true },
    writer: { value: input.writer ?? null, isWritable: true },
    tokenProgram: { value: input.tokenProgram ?? null, isWritable: false },
    systemProgram: { value: input.systemProgram ?? null, isWritable: false },
  };
  const accounts = originalAccounts as Record<
    keyof typeof originalAccounts,
    ResolvedAccount
  >;

  // Original args.
  const args = { ...input };

  // Resolve default values.
  if (!accounts.collateralPool.value) {
    accounts.collateralPool.value = await getProgramDerivedAddress({
      programAddress,
      seeds: [
        getBytesEncoder().encode(
          new Uint8Array([
            99, 111, 108, 108, 97, 116, 101, 114, 97, 108, 95, 112, 111, 111,
            108,
          ]),
        ),
        getAddressEncoder().encode(expectAddress(accounts.optionAccount.value)),
      ],
    });
  }
  if (!accounts.writerPosition.value) {
    accounts.writerPosition.value = await getProgramDerivedAddress({
      programAddress,
      seeds: [
        getBytesEncoder().encode(
          new Uint8Array([
            119, 114, 105, 116, 101, 114, 95, 112, 111, 115, 105, 116, 105, 111,
            110,
          ]),
        ),
        getAddressEncoder().encode(expectAddress(accounts.optionPool.value)),
        getAddressEncoder().encode(expectAddress(accounts.writer.value)),
      ],
    });
  }
  if (!accounts.tokenProgram.value) {
    accounts.tokenProgram.value =
      "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA" as Address<"TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA">;
  }
  if (!accounts.systemProgram.value) {
    accounts.systemProgram.value =
      "11111111111111111111111111111111" as Address<"11111111111111111111111111111111">;
  }

  const getAccountMeta = getAccountMetaFactory(programAddress, "programId");
  return Object.freeze({
    accounts: [
      getAccountMeta(accounts.optionPool),
      getAccountMeta(accounts.optionAccount),
      getAccountMeta(accounts.collateralPool),
      getAccountMeta(accounts.writerPosition),
      getAccountMeta(accounts.writerLongAccount),
      getAccountMeta(accounts.writerShortAccount),
      getAccountMeta(accounts.writerCollateralAccount),
      getAccountMeta(accounts.escrowLongAccount),
      getAccountMeta(accounts.collateralVault),
      getAccountMeta(accounts.writer),
      getAccountMeta(accounts.tokenProgram),
      getAccountMeta(accounts.systemProgram),
    ],
    data: getWriteToPoolInstructionDataEncoder().encode(
      args as WriteToPoolInstructionDataArgs,
    ),
    programAddress,
  } as WriteToPoolInstruction<
    TProgramAddress,
    TAccountOptionPool,
    TAccountOptionAccount,
    TAccountCollateralPool,
    TAccountWriterPosition,
    TAccountWriterLongAccount,
    TAccountWriterShortAccount,
    TAccountWriterCollateralAccount,
    TAccountEscrowLongAccount,
    TAccountCollateralVault,
    TAccountWriter,
    TAccountTokenProgram,
    TAccountSystemProgram
  >);
}

export type WriteToPoolInput<
  TAccountOptionPool extends string = string,
  TAccountOptionAccount extends string = string,
  TAccountCollateralPool extends string = string,
  TAccountWriterPosition extends string = string,
  TAccountWriterLongAccount extends string = string,
  TAccountWriterShortAccount extends string = string,
  TAccountWriterCollateralAccount extends string = string,
  TAccountEscrowLongAccount extends string = string,
  TAccountCollateralVault extends string = string,
  TAccountWriter extends string = string,
  TAccountTokenProgram extends string = string,
  TAccountSystemProgram extends string = string,
> = {
  /** The pool to write into */
  optionPool: Address<TAccountOptionPool>;
  /** The option account */
  optionAccount: Address<TAccountOptionAccount>;
  /** Collateral pool for this option */
  collateralPool: Address<TAccountCollateralPool>;
  /** Writer's unified position account (single source of truth) */
  writerPosition: Address<TAccountWriterPosition>;
  /** Writer's LONG token account (source - depositing to pool) */
  writerLongAccount: Address<TAccountWriterLongAccount>;
  /** Writer's SHORT token account (already holds SHORT from minting) */
  writerShortAccount: Address<TAccountWriterShortAccount>;
  /** Writer's collateral account (source of own collateral) */
  writerCollateralAccount: Address<TAccountWriterCollateralAccount>;
  /** Pool's LONG escrow (destination for LONG tokens) */
  escrowLongAccount: Address<TAccountEscrowLongAccount>;
  /** Pool's collateral vault (destination for collateral) */
  collateralVault: Address<TAccountCollateralVault>;
  writer: TransactionSigner<TAccountWriter>;
  tokenProgram?: Address<TAccountTokenProgram>;
  systemProgram?: Address<TAccountSystemProgram>;
  longQty: WriteToPoolInstructionDataArgs["longQty"];
  collateralAmount: WriteToPoolInstructionDataArgs["collateralAmount"];
};

export function getWriteToPoolInstruction<
  TAccountOptionPool extends string,
  TAccountOptionAccount extends string,
  TAccountCollateralPool extends string,
  TAccountWriterPosition extends string,
  TAccountWriterLongAccount extends string,
  TAccountWriterShortAccount extends string,
  TAccountWriterCollateralAccount extends string,
  TAccountEscrowLongAccount extends string,
  TAccountCollateralVault extends string,
  TAccountWriter extends string,
  TAccountTokenProgram extends string,
  TAccountSystemProgram extends string,
  TProgramAddress extends Address = typeof OPTION_PROGRAM_PROGRAM_ADDRESS,
>(
  input: WriteToPoolInput<
    TAccountOptionPool,
    TAccountOptionAccount,
    TAccountCollateralPool,
    TAccountWriterPosition,
    TAccountWriterLongAccount,
    TAccountWriterShortAccount,
    TAccountWriterCollateralAccount,
    TAccountEscrowLongAccount,
    TAccountCollateralVault,
    TAccountWriter,
    TAccountTokenProgram,
    TAccountSystemProgram
  >,
  config?: { programAddress?: TProgramAddress },
): WriteToPoolInstruction<
  TProgramAddress,
  TAccountOptionPool,
  TAccountOptionAccount,
  TAccountCollateralPool,
  TAccountWriterPosition,
  TAccountWriterLongAccount,
  TAccountWriterShortAccount,
  TAccountWriterCollateralAccount,
  TAccountEscrowLongAccount,
  TAccountCollateralVault,
  TAccountWriter,
  TAccountTokenProgram,
  TAccountSystemProgram
> {
  // Program address.
  const programAddress =
    config?.programAddress ?? OPTION_PROGRAM_PROGRAM_ADDRESS;

  // Original accounts.
  const originalAccounts = {
    optionPool: { value: input.optionPool ?? null, isWritable: true },
    optionAccount: { value: input.optionAccount ?? null, isWritable: true },
    collateralPool: { value: input.collateralPool ?? null, isWritable: true },
    writerPosition: { value: input.writerPosition ?? null, isWritable: true },
    writerLongAccount: {
      value: input.writerLongAccount ?? null,
      isWritable: true,
    },
    writerShortAccount: {
      value: input.writerShortAccount ?? null,
      isWritable: false,
    },
    writerCollateralAccount: {
      value: input.writerCollateralAccount ?? null,
      isWritable: true,
    },
    escrowLongAccount: {
      value: input.escrowLongAccount ?? null,
      isWritable: true,
    },
    collateralVault: { value: input.collateralVault ?? null, isWritable: true },
    writer: { value: input.writer ?? null, isWritable: true },
    tokenProgram: { value: input.tokenProgram ?? null, isWritable: false },
    systemProgram: { value: input.systemProgram ?? null, isWritable: false },
  };
  const accounts = originalAccounts as Record<
    keyof typeof originalAccounts,
    ResolvedAccount
  >;

  // Original args.
  const args = { ...input };

  // Resolve default values.
  if (!accounts.tokenProgram.value) {
    accounts.tokenProgram.value =
      "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA" as Address<"TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA">;
  }
  if (!accounts.systemProgram.value) {
    accounts.systemProgram.value =
      "11111111111111111111111111111111" as Address<"11111111111111111111111111111111">;
  }

  const getAccountMeta = getAccountMetaFactory(programAddress, "programId");
  return Object.freeze({
    accounts: [
      getAccountMeta(accounts.optionPool),
      getAccountMeta(accounts.optionAccount),
      getAccountMeta(accounts.collateralPool),
      getAccountMeta(accounts.writerPosition),
      getAccountMeta(accounts.writerLongAccount),
      getAccountMeta(accounts.writerShortAccount),
      getAccountMeta(accounts.writerCollateralAccount),
      getAccountMeta(accounts.escrowLongAccount),
      getAccountMeta(accounts.collateralVault),
      getAccountMeta(accounts.writer),
      getAccountMeta(accounts.tokenProgram),
      getAccountMeta(accounts.systemProgram),
    ],
    data: getWriteToPoolInstructionDataEncoder().encode(
      args as WriteToPoolInstructionDataArgs,
    ),
    programAddress,
  } as WriteToPoolInstruction<
    TProgramAddress,
    TAccountOptionPool,
    TAccountOptionAccount,
    TAccountCollateralPool,
    TAccountWriterPosition,
    TAccountWriterLongAccount,
    TAccountWriterShortAccount,
    TAccountWriterCollateralAccount,
    TAccountEscrowLongAccount,
    TAccountCollateralVault,
    TAccountWriter,
    TAccountTokenProgram,
    TAccountSystemProgram
  >);
}

export type ParsedWriteToPoolInstruction<
  TProgram extends string = typeof OPTION_PROGRAM_PROGRAM_ADDRESS,
  TAccountMetas extends readonly AccountMeta[] = readonly AccountMeta[],
> = {
  programAddress: Address<TProgram>;
  accounts: {
    /** The pool to write into */
    optionPool: TAccountMetas[0];
    /** The option account */
    optionAccount: TAccountMetas[1];
    /** Collateral pool for this option */
    collateralPool: TAccountMetas[2];
    /** Writer's unified position account (single source of truth) */
    writerPosition: TAccountMetas[3];
    /** Writer's LONG token account (source - depositing to pool) */
    writerLongAccount: TAccountMetas[4];
    /** Writer's SHORT token account (already holds SHORT from minting) */
    writerShortAccount: TAccountMetas[5];
    /** Writer's collateral account (source of own collateral) */
    writerCollateralAccount: TAccountMetas[6];
    /** Pool's LONG escrow (destination for LONG tokens) */
    escrowLongAccount: TAccountMetas[7];
    /** Pool's collateral vault (destination for collateral) */
    collateralVault: TAccountMetas[8];
    writer: TAccountMetas[9];
    tokenProgram: TAccountMetas[10];
    systemProgram: TAccountMetas[11];
  };
  data: WriteToPoolInstructionData;
};

export function parseWriteToPoolInstruction<
  TProgram extends string,
  TAccountMetas extends readonly AccountMeta[],
>(
  instruction: Instruction<TProgram> &
    InstructionWithAccounts<TAccountMetas> &
    InstructionWithData<ReadonlyUint8Array>,
): ParsedWriteToPoolInstruction<TProgram, TAccountMetas> {
  if (instruction.accounts.length < 12) {
    // TODO: Coded error.
    throw new Error("Not enough accounts");
  }
  let accountIndex = 0;
  const getNextAccount = () => {
    const accountMeta = (instruction.accounts as TAccountMetas)[accountIndex]!;
    accountIndex += 1;
    return accountMeta;
  };
  return {
    programAddress: instruction.programAddress,
    accounts: {
      optionPool: getNextAccount(),
      optionAccount: getNextAccount(),
      collateralPool: getNextAccount(),
      writerPosition: getNextAccount(),
      writerLongAccount: getNextAccount(),
      writerShortAccount: getNextAccount(),
      writerCollateralAccount: getNextAccount(),
      escrowLongAccount: getNextAccount(),
      collateralVault: getNextAccount(),
      writer: getNextAccount(),
      tokenProgram: getNextAccount(),
      systemProgram: getNextAccount(),
    },
    data: getWriteToPoolInstructionDataDecoder().decode(instruction.data),
  };
}
